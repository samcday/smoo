name: Create release from tag
on:
  push:
    tags: ['v*']
permissions:
  contents: write
jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - name: Require release automation token
        env:
          RELEASE_GITHUB_TOKEN: ${{ secrets.RELEASE_GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          if [[ -z "$RELEASE_GITHUB_TOKEN" ]]; then
            echo "RELEASE_GITHUB_TOKEN secret is required for release automation."
            exit 1
          fi

      - name: Detect prerelease tag
        id: prerelease
        env:
          TAG_NAME: ${{ github.ref_name }}
        run: |
          set -euo pipefail
          if [[ "$TAG_NAME" =~ -rc\.[0-9]+$ ]]; then
            echo "value=true" >> "$GITHUB_OUTPUT"
          else
            echo "value=false" >> "$GITHUB_OUTPUT"
          fi

      - uses: actions/checkout@v4
      - uses: softprops/action-gh-release@v2
        with:
          generate_release_notes: true
          prerelease: ${{ steps.prerelease.outputs.value }}
          token: ${{ secrets.RELEASE_GITHUB_TOKEN }}
