name: Release

on:
  push:
    branches:
      - "release/v*"
    tags:
      - "v*"

permissions:
  contents: write
  pull-requests: write

jobs:
  gate:
    runs-on: ubuntu-latest
    outputs:
      enabled: ${{ steps.detect.outputs.enabled }}
      mode: ${{ steps.detect.outputs.mode }}
      prerelease: ${{ steps.detect.outputs.prerelease }}
      version: ${{ steps.detect.outputs.version }}
      tag: ${{ steps.detect.outputs.tag }}
    steps:
      - id: detect
        env:
          EVENT_NAME: ${{ github.event_name }}
          REF_TYPE: ${{ github.ref_type }}
          REF_NAME: ${{ github.ref_name }}
        run: |
          set -euo pipefail

          enabled=false
          mode=none
          prerelease=false
          version=""

          if [[ "$EVENT_NAME" == "push" ]] \
            && [[ "$REF_TYPE" == "tag" ]] \
            && [[ "$REF_NAME" =~ ^v([0-9]+\.[0-9]+\.[0-9]+(-rc\.[0-9]+)?)$ ]]; then
            enabled=true
            mode=tag
            version="${BASH_REMATCH[1]}"
          elif [[ "$EVENT_NAME" == "push" ]] \
            && [[ "$REF_TYPE" == "branch" ]] \
            && [[ "$REF_NAME" =~ ^release/v([0-9]+\.[0-9]+\.[0-9]+(-rc\.[0-9]+)?)$ ]]; then
            enabled=true
            mode=pr
            version="${BASH_REMATCH[1]}"
          fi

          if [[ -n "$version" && "$version" =~ -rc\.[0-9]+$ ]]; then
            prerelease=true
          fi

          echo "enabled=$enabled" >> "$GITHUB_OUTPUT"
          echo "mode=$mode" >> "$GITHUB_OUTPUT"
          echo "prerelease=$prerelease" >> "$GITHUB_OUTPUT"
          echo "version=$version" >> "$GITHUB_OUTPUT"
          echo "tag=v$version" >> "$GITHUB_OUTPUT"

  release:
    needs: gate
    if: needs.gate.outputs.enabled == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Require release automation token
        env:
          RELEASE_GITHUB_TOKEN: ${{ secrets.RELEASE_GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          if [[ -z "$RELEASE_GITHUB_TOKEN" ]]; then
            echo "RELEASE_GITHUB_TOKEN secret is required for release automation."
            exit 1
          fi

      - uses: actions/checkout@v4

      - if: needs.gate.outputs.mode == 'tag'
        id: create_release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.gate.outputs.tag }}
          generate_release_notes: true
          prerelease: ${{ needs.gate.outputs.prerelease }}
          draft: true
          token: ${{ secrets.RELEASE_GITHUB_TOKEN }}

      - if: needs.gate.outputs.mode == 'pr'
        run: |
          echo "release/v* branch mode: skipping draft creation"

  ci-build:
    needs: [gate, release]
    if: needs.gate.outputs.enabled == 'true'
    uses: ./.github/workflows/build.yml
    secrets: inherit

  ci-alpine-arm64:
    needs: [gate, release]
    if: needs.gate.outputs.enabled == 'true'
    uses: ./.github/workflows/alpine-arm64.yml
    secrets: inherit

  dry-run:
    needs: [gate, release, ci-build, ci-alpine-arm64]
    if: needs.gate.outputs.enabled == 'true'
    runs-on: ubuntu-latest
    steps:
      - if: needs.gate.outputs.mode == 'pr'
        uses: actions/checkout@v4

      - if: needs.gate.outputs.mode == 'pr'
        uses: taiki-e/install-action@just

      - if: needs.gate.outputs.mode == 'pr'
        name: Validate bump is idempotent
        env:
          VERSION: ${{ needs.gate.outputs.version }}
        run: |
          set -euo pipefail
          just bump "$VERSION"

          if ! git diff --quiet; then
            echo "::error::release branch is not in a post-bump state for ${VERSION}"
            git --no-pager diff --stat
            exit 1
          fi

      - if: needs.gate.outputs.mode == 'tag'
        name: Skip dry-run in tag mode
        run: |
          echo "tag mode: dry-run bump validation is not required"

  publish-crates:
    needs: [gate, release, ci-build, ci-alpine-arm64]
    if: needs.gate.outputs.enabled == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: taiki-e/install-action@just

      - if: needs.gate.outputs.mode == 'pr'
        name: Validate crate publish (dry-run)
        run: just publish-dry-run

      - if: needs.gate.outputs.mode == 'tag'
        name: Publish crates to crates.io
        env:
          CARGO_REGISTRY_TOKEN: ${{ secrets.CARGO_REGISTRY_TOKEN }}
        run: just publish

  pass:
    name: "âœ… Pass"
    needs: [gate, release, ci-build, ci-alpine-arm64, dry-run, publish-crates]
    runs-on: ubuntu-latest
    if: always() && needs.gate.outputs.enabled == 'true'
    steps:
      - uses: re-actors/alls-green@release/v1
        with:
          jobs: ${{ toJSON(needs) }}

  publish-release:
    needs: [gate, release, pass]
    if: needs.gate.outputs.mode == 'tag' && needs.pass.result == 'success'
    runs-on: ubuntu-latest
    steps:
      - name: Publish draft release
        env:
          GH_TOKEN: ${{ secrets.RELEASE_GITHUB_TOKEN }}
          TAG_NAME: ${{ needs.gate.outputs.tag }}
        run: |
          set -euo pipefail

          gh release edit "$TAG_NAME" --repo "$GITHUB_REPOSITORY" --draft=false >/dev/null

          draft_state="$(gh api "repos/${GITHUB_REPOSITORY}/releases/tags/${TAG_NAME}" --jq '.draft')"
          if [[ "$draft_state" != "false" ]]; then
            echo "::error::release ${TAG_NAME} is still marked as draft"
            exit 1
          fi
