name: Release follow-ups

on:
  pull_request:
    types: [closed]

permissions:
  contents: write
  pull-requests: write

jobs:
  tag-release-pr:
    if: github.event.pull_request.merged == true && github.event.pull_request.head.repo.full_name == github.repository && startsWith(github.event.pull_request.head.ref, 'release/v')
    runs-on: ubuntu-latest
    steps:
      - name: Require release automation token
        env:
          RELEASE_GITHUB_TOKEN: ${{ secrets.RELEASE_GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          if [[ -z "$RELEASE_GITHUB_TOKEN" ]]; then
            echo "RELEASE_GITHUB_TOKEN secret is required for release tag automation."
            exit 1
          fi

      - name: Parse tag from release branch
        id: parse
        env:
          HEAD_REF: ${{ github.event.pull_request.head.ref }}
        run: |
          set -euo pipefail
          version="${HEAD_REF#release/v}"

          if [[ "$version" =~ ^([0-9]+\.[0-9]+\.[0-9]+)-rc\.([0-9]+)$ ]]; then
            tag="v${BASH_REMATCH[1]}-rc.${BASH_REMATCH[2]}"
          elif [[ "$version" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            tag="v$version"
          else
            echo "skip=true" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          echo "tag=$tag" >> "$GITHUB_OUTPUT"

      - name: Create and push tag
        if: steps.parse.outputs.skip != 'true'
        env:
          GH_TOKEN: ${{ secrets.RELEASE_GITHUB_TOKEN }}
          TAG: ${{ steps.parse.outputs.tag }}
          MERGE_SHA: ${{ github.event.pull_request.merge_commit_sha }}
        run: |
          set -euo pipefail

          if [[ -z "$MERGE_SHA" ]]; then
            echo "No merge commit sha found; skipping"
            exit 0
          fi

          if gh api "repos/${GITHUB_REPOSITORY}/git/ref/tags/${TAG}" >/dev/null 2>&1; then
            echo "Tag ${TAG} already exists; nothing to do"
            exit 0
          fi

          gh api -X POST "repos/${GITHUB_REPOSITORY}/git/refs" \
            -f ref="refs/tags/${TAG}" \
            -f sha="$MERGE_SHA" >/dev/null

  next-rc:
    if: github.event.pull_request.merged == true && github.event.pull_request.head.repo.full_name == github.repository && startsWith(github.event.pull_request.head.ref, 'release/v')
    runs-on: ubuntu-latest
    steps:
      - name: Parse next rc version from merged release branch
        id: parse
        env:
          HEAD_REF: ${{ github.event.pull_request.head.ref }}
        run: |
          set -euo pipefail
          version="${HEAD_REF#release/v}"

          if [[ "$version" =~ ^([0-9]+\.[0-9]+\.[0-9]+)-rc\.([0-9]+)$ ]]; then
            base="${BASH_REMATCH[1]}"
            rc="${BASH_REMATCH[2]}"
            next_rc=$((rc + 1))
            echo "version=${base}-rc.${next_rc}" >> "$GITHUB_OUTPUT"
          else
            echo "skip=true" >> "$GITHUB_OUTPUT"
          fi

      - name: Require release automation token
        if: steps.parse.outputs.skip != 'true'
        env:
          RELEASE_GITHUB_TOKEN: ${{ secrets.RELEASE_GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          if [[ -z "$RELEASE_GITHUB_TOKEN" ]]; then
            echo "RELEASE_GITHUB_TOKEN secret is required for follow-up rc automation."
            exit 1
          fi

      - uses: actions/checkout@v4
        if: steps.parse.outputs.skip != 'true'
        with:
          ref: ${{ github.event.repository.default_branch }}
          token: ${{ secrets.RELEASE_GITHUB_TOKEN }}

      - uses: taiki-e/install-action@just
        if: steps.parse.outputs.skip != 'true'

      - name: Configure git
        if: steps.parse.outputs.skip != 'true'
        run: |
          git config user.name "SmooBot"
          git config user.email "smoo@beep.boop"

      - name: Create next rc PR
        if: steps.parse.outputs.skip != 'true'
        env:
          GH_TOKEN: ${{ secrets.RELEASE_GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          version="${{ steps.parse.outputs.version }}"
          branch="release/v${version}"
          base="${{ github.event.repository.default_branch }}"

          if [[ -n "$(git ls-remote --heads origin "$branch")" ]]; then
            echo "Branch $branch already exists; skipping"
            exit 0
          fi

          git checkout -b "$branch"
          just bump "$version"

          if git diff --quiet; then
            echo "No version changes for $version; skipping"
            exit 0
          fi

          git add -A
          git commit -m "release: v${version}"
          git push -u origin "$branch"
          gh pr create \
            --title "v${version}" \
            --body "Automated bump for v${version}." \
            --base "$base"
